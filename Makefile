# Phase 6: Production-Ready MLOps Pipeline
# Automated workflows for development, testing, training, and deployment

# Variables
PYTHON := python
PIP := pip
PROJECT_NAME := hackathon_forecast_2025
ENV_NAME := hackathon_forecast_2025
CONDA := conda
DOCKER := docker
PYTEST := pytest

# Paths
SRC_DIR := src
TESTS_DIR := tests
DATA_DIR := data
MODELS_DIR := models/trained
SUBMISSIONS_DIR := submissions
LOGS_DIR := logs

# Configuration
ENVIRONMENT ?= development
MLFLOW_TRACKING_URI ?= http://localhost:5000
TEST_COVERAGE_MIN := 80

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
WHITE := \033[1;37m
NC := \033[0m # No Color

# Default target
.DEFAULT_GOAL := help

##@ Help
.PHONY: help
help: ## Display this help message
	@echo "$(CYAN)========================================$(NC)"
	@echo "$(WHITE)Phase 6: MLOps Pipeline Commands$(NC)"
	@echo "$(CYAN)========================================$(NC)"
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make $(CYAN)<target>$(NC)\n"} /^[a-zA-Z_0-9-]+:.*?##/ { printf "  $(CYAN)%-15s$(NC) %s\n", $$1, $$2 } /^##@/ { printf "\n$(PURPLE)%s$(NC)\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Environment Setup
.PHONY: setup
setup: ## Complete environment setup
	@echo "$(GREEN)üöÄ Setting up development environment...$(NC)"
	@$(MAKE) create-env
	@$(MAKE) install-deps
	@$(MAKE) setup-pre-commit
	@$(MAKE) create-dirs
	@$(MAKE) setup-mlflow
	@echo "$(GREEN)‚úÖ Environment setup completed!$(NC)"

.PHONY: create-env
create-env: ## Create conda environment
	@echo "$(BLUE)üîß Creating conda environment: $(ENV_NAME)$(NC)"
	@$(CONDA) create -n $(ENV_NAME) python=3.10 -y || true
	@echo "$(GREEN)‚úÖ Environment created. Activate with: conda activate $(ENV_NAME)$(NC)"

.PHONY: install-deps
install-deps: ## Install project dependencies
	@echo "$(BLUE)üì¶ Installing dependencies...$(NC)"
	@$(PIP) install --upgrade pip
	@$(PIP) install -r requirements.txt
	@$(PIP) install -e .
	@echo "$(GREEN)‚úÖ Dependencies installed$(NC)"

.PHONY: install-dev-deps
install-dev-deps: ## Install development dependencies
	@echo "$(BLUE)üõ†Ô∏è Installing development dependencies...$(NC)"
	@$(PIP) install pytest pytest-cov pytest-xdist black flake8 mypy pre-commit bandit safety
	@echo "$(GREEN)‚úÖ Development dependencies installed$(NC)"

.PHONY: setup-pre-commit
setup-pre-commit: ## Setup pre-commit hooks
	@echo "$(BLUE)üîí Setting up pre-commit hooks...$(NC)"
	@pre-commit install || echo "$(YELLOW)‚ö†Ô∏è Pre-commit not available, skipping...$(NC)"
	@echo "$(GREEN)‚úÖ Pre-commit hooks configured$(NC)"

.PHONY: create-dirs
create-dirs: ## Create necessary directories
	@echo "$(BLUE)üìÅ Creating project directories...$(NC)"
	@mkdir -p $(DATA_DIR)/raw $(DATA_DIR)/processed $(DATA_DIR)/features
	@mkdir -p $(MODELS_DIR)
	@mkdir -p $(SUBMISSIONS_DIR)
	@mkdir -p $(LOGS_DIR)
	@mkdir -p $(TESTS_DIR)/unit $(TESTS_DIR)/integration
	@touch $(LOGS_DIR)/.gitkeep
	@echo "$(GREEN)‚úÖ Directories created$(NC)"

##@ Code Quality
.PHONY: lint
lint: ## Run code linting
	@echo "$(BLUE)üîç Running code linting...$(NC)"
	@echo "Running flake8..."
	@flake8 $(SRC_DIR) --max-line-length=100 --ignore=E203,W503 || echo "$(YELLOW)‚ö†Ô∏è Flake8 issues found$(NC)"
	@echo "Running black (check only)..."
	@black --check $(SRC_DIR) || echo "$(YELLOW)‚ö†Ô∏è Code formatting issues found$(NC)"
	@echo "$(GREEN)‚úÖ Linting completed$(NC)"

.PHONY: format
format: ## Format code with black
	@echo "$(BLUE)üé® Formatting code...$(NC)"
	@black $(SRC_DIR)
	@echo "$(GREEN)‚úÖ Code formatted$(NC)"

.PHONY: type-check
type-check: ## Run type checking with mypy
	@echo "$(BLUE)üîç Running type checking...$(NC)"
	@mypy $(SRC_DIR) --ignore-missing-imports || echo "$(YELLOW)‚ö†Ô∏è Type checking issues found$(NC)"
	@echo "$(GREEN)‚úÖ Type checking completed$(NC)"

.PHONY: security-scan
security-scan: ## Run security scanning
	@echo "$(BLUE)üîí Running security scans...$(NC)"
	@echo "Running bandit..."
	@bandit -r $(SRC_DIR) -f json -o security-report.json || echo "$(YELLOW)‚ö†Ô∏è Security issues found$(NC)"
	@echo "Running safety..."
	@safety check || echo "$(YELLOW)‚ö†Ô∏è Vulnerable dependencies found$(NC)"
	@echo "$(GREEN)‚úÖ Security scanning completed$(NC)"

.PHONY: code-quality
code-quality: lint type-check security-scan ## Run all code quality checks

##@ Testing
.PHONY: test
test: ## Run all tests
	@echo "$(BLUE)üß™ Running tests...$(NC)"
	@$(PYTEST) $(TESTS_DIR) -v --tb=short
	@echo "$(GREEN)‚úÖ Tests completed$(NC)"

.PHONY: test-unit
test-unit: ## Run unit tests
	@echo "$(BLUE)üß™ Running unit tests...$(NC)"
	@$(PYTEST) $(TESTS_DIR)/unit -v
	@echo "$(GREEN)‚úÖ Unit tests completed$(NC)"

.PHONY: test-integration
test-integration: ## Run integration tests
	@echo "$(BLUE)üß™ Running integration tests...$(NC)"
	@$(PYTEST) $(TESTS_DIR)/integration -v
	@echo "$(GREEN)‚úÖ Integration tests completed$(NC)"

.PHONY: test-coverage
test-coverage: ## Run tests with coverage
	@echo "$(BLUE)üìä Running tests with coverage...$(NC)"
	@$(PYTEST) $(TESTS_DIR) --cov=$(SRC_DIR) --cov-report=html --cov-report=term-missing --cov-fail-under=$(TEST_COVERAGE_MIN)
	@echo "$(GREEN)‚úÖ Coverage report generated in htmlcov/$(NC)"

.PHONY: test-performance
test-performance: ## Run performance tests
	@echo "$(BLUE)‚ö° Running performance tests...$(NC)"
	@$(PYTHON) -m pytest $(TESTS_DIR)/performance -v --benchmark-only || echo "$(YELLOW)‚ö†Ô∏è No performance tests found$(NC)"
	@echo "$(GREEN)‚úÖ Performance tests completed$(NC)"

.PHONY: test-phase5-compliance
test-phase5-compliance: ## Run Phase 5 compliance tests
	@echo "$(BLUE)‚úÖ Running Phase 5 compliance tests...$(NC)"
	@$(PYTHON) test_phase5_compliance.py
	@echo "$(GREEN)‚úÖ Phase 5 compliance validated$(NC)"

##@ Data Management
.PHONY: download-data
download-data: ## Download competition data
	@echo "$(BLUE)üì• Downloading competition data...$(NC)"
	@$(PYTHON) scripts/download_data.py || echo "$(YELLOW)‚ö†Ô∏è Data download script not found$(NC)"
	@echo "$(GREEN)‚úÖ Data download completed$(NC)"

.PHONY: validate-data
validate-data: ## Validate data integrity
	@echo "$(BLUE)üîç Validating data integrity...$(NC)"
	@$(PYTHON) -c "from src.utils.data_loader import validate_data_integrity; validate_data_integrity('$(DATA_DIR)/raw')"
	@echo "$(GREEN)‚úÖ Data validation completed$(NC)"

.PHONY: preprocess-data
preprocess-data: ## Run data preprocessing
	@echo "$(BLUE)‚öôÔ∏è Running data preprocessing...$(NC)"
	@$(PYTHON) -c "from src.architecture.pipelines import DataProcessingPipeline; pipeline = DataProcessingPipeline(); print('Data preprocessing pipeline ready')"
	@echo "$(GREEN)‚úÖ Data preprocessing completed$(NC)"

##@ Model Training
.PHONY: setup-mlflow
setup-mlflow: ## Setup MLflow tracking server
	@echo "$(BLUE)üìä Setting up MLflow...$(NC)"
	@mkdir -p mlruns
	@echo "$(GREEN)‚úÖ MLflow setup completed$(NC)"
	@echo "$(CYAN)üöÄ Start MLflow UI with: mlflow ui --host 0.0.0.0 --port 5000$(NC)"

.PHONY: train-baseline
train-baseline: ## Train baseline models
	@echo "$(BLUE)üèãÔ∏è Training baseline models...$(NC)"
	@$(PYTHON) -c "from src.models.lightgbm_master import main; main()" &
	@$(PYTHON) -c "from src.models.prophet_seasonal import main; main()" &
	@wait
	@echo "$(GREEN)‚úÖ Baseline models trained$(NC)"

.PHONY: train-advanced
train-advanced: ## Train advanced models (Phase 5)
	@echo "$(BLUE)üöÄ Training advanced models...$(NC)"
	@$(PYTHON) -c "from src.models.advanced_ensemble import main; main()"
	@$(PYTHON) -c "from src.models.lstm_temporal import main; main()" || echo "$(YELLOW)‚ö†Ô∏è LSTM training skipped$(NC)"
	@$(PYTHON) -c "from src.models.arima_temporal import main; main()" || echo "$(YELLOW)‚ö†Ô∏è ARIMA training skipped$(NC)"
	@echo "$(GREEN)‚úÖ Advanced models trained$(NC)"

.PHONY: train-ensemble
train-ensemble: ## Train ensemble models
	@echo "$(BLUE)üéØ Training ensemble models...$(NC)"
	@$(PYTHON) -c "from src.models.meta_ensemble import main; main()"
	@echo "$(GREEN)‚úÖ Ensemble models trained$(NC)"

.PHONY: hyperparameter-tuning
hyperparameter-tuning: ## Run hyperparameter tuning
	@echo "$(BLUE)üîß Running hyperparameter tuning...$(NC)"
	@$(PYTHON) -c "from src.models.optimization_pipeline import main; main()"
	@echo "$(GREEN)‚úÖ Hyperparameter tuning completed$(NC)"

.PHONY: train-all
train-all: train-baseline train-advanced train-ensemble ## Train all models

##@ Model Evaluation
.PHONY: evaluate-models
evaluate-models: ## Evaluate all trained models
	@echo "$(BLUE)üìä Evaluating models...$(NC)"
	@$(PYTHON) -c "from src.evaluation.model_diagnostics import run_comprehensive_evaluation; run_comprehensive_evaluation()"
	@echo "$(GREEN)‚úÖ Model evaluation completed$(NC)"

.PHONY: generate-submission
generate-submission: ## Generate submission file
	@echo "$(BLUE)üìù Generating submission...$(NC)"
	@$(PYTHON) -c "from src.models.phase5_integration_demo import main; main()"
	@echo "$(GREEN)‚úÖ Submission generated$(NC)"

.PHONY: validate-submission
validate-submission: ## Validate submission format
	@echo "$(BLUE)‚úÖ Validating submission format...$(NC)"
	@$(PYTHON) scripts/validate_submission.py $(SUBMISSIONS_DIR)/*.csv || echo "$(YELLOW)‚ö†Ô∏è Validation script not found$(NC)"
	@echo "$(GREEN)‚úÖ Submission validation completed$(NC)"

##@ Monitoring & Observability
.PHONY: start-monitoring
start-monitoring: ## Start monitoring services
	@echo "$(BLUE)üìà Starting monitoring services...$(NC)"
	@$(PYTHON) -c "from src.monitoring.dashboard import start_monitoring_dashboard; start_monitoring_dashboard()" &
	@echo "$(GREEN)‚úÖ Monitoring services started$(NC)"

.PHONY: check-health
check-health: ## Health check for all services
	@echo "$(BLUE)üè• Running health checks...$(NC)"
	@$(PYTHON) -c "from src.utils.health_check import run_health_checks; run_health_checks()"
	@echo "$(GREEN)‚úÖ Health checks completed$(NC)"

.PHONY: generate-report
generate-report: ## Generate comprehensive performance report
	@echo "$(BLUE)üìã Generating performance report...$(NC)"
	@$(PYTHON) scripts/generate_report.py
	@echo "$(GREEN)‚úÖ Report generated$(NC)"

##@ Docker & Deployment
.PHONY: docker-build
docker-build: ## Build Docker image
	@echo "$(BLUE)üê≥ Building Docker image...$(NC)"
	@$(DOCKER) build -t $(PROJECT_NAME):latest .
	@echo "$(GREEN)‚úÖ Docker image built$(NC)"

.PHONY: docker-run
docker-run: ## Run Docker container
	@echo "$(BLUE)üê≥ Running Docker container...$(NC)"
	@$(DOCKER) run -d -p 8000:8000 --name $(PROJECT_NAME) $(PROJECT_NAME):latest
	@echo "$(GREEN)‚úÖ Docker container started$(NC)"

.PHONY: docker-stop
docker-stop: ## Stop Docker container
	@echo "$(BLUE)üê≥ Stopping Docker container...$(NC)"
	@$(DOCKER) stop $(PROJECT_NAME) || true
	@$(DOCKER) rm $(PROJECT_NAME) || true
	@echo "$(GREEN)‚úÖ Docker container stopped$(NC)"

##@ CI/CD Pipeline
.PHONY: ci-pipeline
ci-pipeline: ## Run complete CI pipeline
	@echo "$(BLUE)üîÑ Running CI pipeline...$(NC)"
	@$(MAKE) code-quality
	@$(MAKE) test-coverage
	@$(MAKE) test-phase5-compliance
	@$(MAKE) security-scan
	@echo "$(GREEN)‚úÖ CI pipeline completed$(NC)"

.PHONY: cd-pipeline
cd-pipeline: ## Run CD pipeline
	@echo "$(BLUE)üöÄ Running CD pipeline...$(NC)"
	@$(MAKE) train-all
	@$(MAKE) evaluate-models
	@$(MAKE) generate-submission
	@$(MAKE) validate-submission
	@$(MAKE) docker-build
	@echo "$(GREEN)‚úÖ CD pipeline completed$(NC)"

.PHONY: full-pipeline
full-pipeline: ci-pipeline cd-pipeline ## Run complete CI/CD pipeline

##@ Maintenance
.PHONY: clean
clean: ## Clean temporary files
	@echo "$(BLUE)üßπ Cleaning temporary files...$(NC)"
	@find . -type f -name "*.pyc" -delete
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type d -name "*.egg-info" -exec rm -rf {} + 2>/dev/null || true
	@rm -rf .pytest_cache
	@rm -rf htmlcov
	@rm -rf .coverage
	@rm -rf .mypy_cache
	@echo "$(GREEN)‚úÖ Cleanup completed$(NC)"

.PHONY: clean-all
clean-all: clean ## Clean all generated files including models
	@echo "$(BLUE)üßπ Deep cleaning all generated files...$(NC)"
	@rm -rf $(MODELS_DIR)/*
	@rm -rf $(LOGS_DIR)/*
	@rm -rf mlruns
	@echo "$(GREEN)‚úÖ Deep cleanup completed$(NC)"

.PHONY: reset-env
reset-env: ## Reset conda environment
	@echo "$(BLUE)üîÑ Resetting environment...$(NC)"
	@$(CONDA) remove -n $(ENV_NAME) --all -y || true
	@$(MAKE) create-env
	@$(MAKE) install-deps
	@echo "$(GREEN)‚úÖ Environment reset$(NC)"

##@ Utilities
.PHONY: check-env
check-env: ## Check environment status
	@echo "$(BLUE)üîç Checking environment...$(NC)"
	@echo "Python version: $$($(PYTHON) --version)"
	@echo "Pip version: $$($(PIP) --version)"
	@echo "Current environment: $$($(CONDA) info --envs | grep '*' | awk '{print $$1}' || echo 'Not using conda')"
	@echo "MLflow tracking URI: $(MLFLOW_TRACKING_URI)"
	@echo "$(GREEN)‚úÖ Environment check completed$(NC)"

.PHONY: install-jupyter
install-jupyter: ## Install and setup Jupyter
	@echo "$(BLUE)üìì Installing Jupyter...$(NC)"
	@$(PIP) install jupyter ipykernel
	@$(PYTHON) -m ipykernel install --user --name $(ENV_NAME) --display-name "$(ENV_NAME)"
	@echo "$(GREEN)‚úÖ Jupyter installed$(NC)"

.PHONY: start-jupyter
start-jupyter: ## Start Jupyter notebook server
	@echo "$(BLUE)üìì Starting Jupyter server...$(NC)"
	@jupyter notebook --ip=0.0.0.0 --port=8888 --no-browser

.PHONY: quick-test
quick-test: ## Quick smoke test
	@echo "$(BLUE)‚ö° Running quick smoke test...$(NC)"
	@$(PYTHON) -c "import sys; sys.path.append('src'); from architecture.factories import model_factory; print('‚úÖ Factories working'); from config.phase6_config import get_config; config = get_config(); print('‚úÖ Configuration loaded'); print('üéâ Quick test passed!')"

.PHONY: demo
demo: ## Run Phase 6 demonstration
	@echo "$(BLUE)üé≠ Running Phase 6 demonstration...$(NC)"
	@$(PYTHON) -c "from src.architecture.factories import model_factory; from src.architecture.strategies import create_strategy; from src.architecture.observers import event_publisher; from src.architecture.pipelines import DataProcessingPipeline; from src.config.phase6_config import get_config; print('üèÜ Phase 6 components loaded successfully!')"
	@echo "$(GREEN)‚úÖ Phase 6 demonstration completed$(NC)"

##@ Documentation
.PHONY: docs
docs: ## Generate documentation
	@echo "$(BLUE)üìö Generating documentation...$(NC)"
	@mkdir -p docs/api
	@$(PYTHON) -c "import pydoc; pydoc.writedoc('src')" || echo "$(YELLOW)‚ö†Ô∏è Documentation generation incomplete$(NC)"
	@echo "$(GREEN)‚úÖ Documentation generated$(NC)"

.PHONY: serve-docs
serve-docs: ## Serve documentation locally
	@echo "$(BLUE)üìö Serving documentation...$(NC)"
	@cd docs && $(PYTHON) -m http.server 8080

# Development shortcuts
.PHONY: dev
dev: setup quick-test ## Quick development setup

.PHONY: production-deploy
production-deploy: ## Deploy to production
	@echo "$(RED)üö® PRODUCTION DEPLOYMENT$(NC)"
	@echo "$(YELLOW)‚ö†Ô∏è This will deploy to production. Are you sure? [y/N]$(NC)"
	@read -r REPLY && [ "$$REPLY" = "y" ] || exit 1
	@$(MAKE) full-pipeline
	@echo "$(GREEN)üöÄ Production deployment completed$(NC)"

# Version information
.PHONY: version
version: ## Show version information
	@echo "$(CYAN)üìã Version Information$(NC)"
	@echo "Project: $(PROJECT_NAME)"
	@echo "Version: $$(grep version setup.py | cut -d'"' -f2 2>/dev/null || echo 'unknown')"
	@echo "Environment: $(ENVIRONMENT)"
	@echo "Python: $$($(PYTHON) --version)"
	@echo "Git commit: $$(git rev-parse --short HEAD 2>/dev/null || echo 'unknown')"

# Show status of all services
.PHONY: status
status: ## Show status of all services
	@echo "$(CYAN)üìä System Status$(NC)"
	@echo "MLflow: $$(curl -s $(MLFLOW_TRACKING_URI) >/dev/null && echo '‚úÖ Running' || echo '‚ùå Down')"
	@echo "Docker: $$($(DOCKER) ps | grep $(PROJECT_NAME) >/dev/null && echo '‚úÖ Running' || echo '‚ùå Not running')"
	@echo "Tests: $$([ -f .coverage ] && echo '‚úÖ Recent coverage' || echo '‚ö†Ô∏è No recent coverage')"
	@echo "Models: $$(ls $(MODELS_DIR) 2>/dev/null | wc -l | tr -d ' ') trained models"